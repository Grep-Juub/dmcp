services:
  # Redis with Vector Search for semantic tool filtering
  redis-vss:
    image: redis/redis-stack-server:latest
    container_name: mcp-redis-vss
    ports:
      - "6380:6379"      # Redis on alternate port (6380) to avoid conflict
    volumes:
      - redis-vss-data:/data
    environment:
      - REDIS_ARGS=--save 60 1 --loglevel warning --protected-mode no
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 512M
    networks:
      - mcp-network

  # Infinity Embedding Service with Tool-Optimized Model
  # Supports any HuggingFace model with OpenAI-compatible API
  # Default: ToolRet-trained e5-large-v2 for better tool retrieval (1024 dims)
  embedding-service:
    image: michaelf34/infinity:latest-cpu  # CPU-optimized image
    platform: linux/amd64
    container_name: mcp-embedding-infinity
    command:
      - v2
      - --model-id
      - ${EMBEDDING_MODEL:-mangopy/ToolRet-trained-e5-large-v2}
      - --port
      - "7997"
      - --engine
      - torch  # Use torch since model doesn't have ONNX files
    ports:
      - "5000:7997"  # Map internal 7997 to external 5000 for compatibility
    volumes:
      - embedding-model-cache:/app/.cache  # HuggingFace cache location
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 6G  # Larger model needs more memory
        reservations:
          cpus: '2'
          memory: 3G
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:7997/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # First download takes longer
    networks:
      - mcp-network

volumes:
  redis-vss-data:
    driver: local
  embedding-model-cache:
    driver: local

networks:
  mcp-network:
    name: mcp-proxy-network
    driver: bridge
