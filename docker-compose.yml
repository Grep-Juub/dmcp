services:
  # Redis with Vector Search for semantic tool filtering
  redis-vss:
    image: redis/redis-stack-server:latest
    container_name: mcp-redis-vss
    ports:
      - "6380:6379"      # Redis on alternate port (6380) to avoid conflict
    volumes:
      - redis-vss-data:/data
    environment:
      - REDIS_ARGS=--save 60 1 --loglevel warning --protected-mode no
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 512M
    networks:
      - mcp-network

  # Infinity Embedding Service with Tool-Optimized Model
  # Supports any HuggingFace model with OpenAI-compatible API
  # Default: ToolRet-trained e5-large-v2 for better tool retrieval (1024 dims)
  embedding-service:
    image: michaelf34/infinity:latest-cpu  # CPU-optimized image
    platform: linux/amd64
    container_name: mcp-embedding-infinity
    command:
      - v2
      - --model-id
      - ${EMBEDDING_MODEL:-mangopy/ToolRet-trained-e5-large-v2}
      - --port
      - "7997"
      - --engine
      - torch  # Use torch since model doesn't have ONNX files
    ports:
      - "5000:7997"  # Map internal 7997 to external 5000 for compatibility
    volumes:
      - embedding-model-cache:/app/.cache  # HuggingFace cache location
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 6G  # Larger model needs more memory
        reservations:
          cpus: '2'
          memory: 3G
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:7997/health', timeout=5)"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 300s  # Model loading can take up to 5 minutes
    networks:
      - mcp-network

  # DMCP Indexer Worker - Keeps tool index in sync
  # Runs continuously and syncs changes from Agent Gateway
  indexer-worker:
    build:
      context: ./indexer
      dockerfile: Dockerfile
    container_name: dmcp-indexer-worker
    environment:
      - MCP_GATEWAY_URL=http://host.docker.internal:15000/config_dump
      - REDIS_HOST=redis-vss
      - REDIS_PORT=6379
      - EMBEDDING_URL=http://embedding-service:7997
      - SYNC_INTERVAL=${SYNC_INTERVAL:-60}
    depends_on:
      redis-vss:
        condition: service_healthy
      embedding-service:
        condition: service_healthy
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Access host network for Agent Gateway
    networks:
      - mcp-network
    profiles:
      - worker  # Only start with: docker-compose --profile worker up

  # DMCP Indexer - One-shot indexing (manual run)
  # Use: docker-compose run --rm indexer
  indexer:
    build:
      context: ./indexer
      dockerfile: Dockerfile
    container_name: dmcp-indexer
    environment:
      - MCP_GATEWAY_URL=http://host.docker.internal:15000/config_dump
      - REDIS_HOST=redis-vss
      - REDIS_PORT=6379
      - EMBEDDING_URL=http://embedding-service:7997
    command: ["node", "dist/index.js"]  # One-shot mode (not worker)
    depends_on:
      redis-vss:
        condition: service_healthy
      embedding-service:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - mcp-network
    profiles:
      - tools  # Only run manually: docker-compose run --rm indexer

  # DMCP Server - MCP tool discovery via Streamable HTTP
  dmcp-server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: dmcp-server
    ports:
      - "3001:3000"  # Expose MCP server on host port 3001
    environment:
      - REDIS_HOST=mcp-redis-vss
      - REDIS_PORT=6379
      - EMBEDDING_URL=http://mcp-embedding-infinity:7997
      - DMCP_TOP_K=15
      - DMCP_MIN_SCORE=0.3
      - PORT=3000
    depends_on:
      redis-vss:
        condition: service_healthy
      embedding-service:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - mcp-network

volumes:
  redis-vss-data:
    driver: local
  embedding-model-cache:
    driver: local

networks:
  mcp-network:
    name: mcp-proxy-network
    driver: bridge
